<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>tripleS Voice Quiz</title>
  <style>
	:root {
	  --accent: #8c52ff;
	  --background: var(--bg-light);
	  --text-color: var(--text-light);
	  --card-bg: var(--card-light);

	  --bg-light: #f5f5f5;
	  --bg-dark: #121212;
	  --card-light: #fff;
	  --card-dark: #1e1e1e;
	  --text-light: #333;
	  --text-dark: #eee;

	  --correct-bg-light: #d4edda;
	  --correct-bg-dark: #295a37;
	  --incorrect-bg-light: #f8d7da;
	  --incorrect-bg-dark: #7a2a2a;
	}

	/* ========== Base Layout ========== */
	body {
	  font-family: 'Segoe UI', sans-serif;
	  text-align: center;
	  padding: 1.5rem;
	  background-color: var(--background);
	  color: var(--text-color);
	  transition: background-color 0.3s, color 0.3s;
	}

	h1 {
	  font-size: 2rem;
	  margin-bottom: 1.5rem;
	}

	label {
	  margin-right: 0.5rem;
	  font-weight: 600;
	}

	select, button, input[type="checkbox"], input[type="radio"] {
	  font-size: 1rem;
	  margin-top: 0.5rem;
	  margin-bottom: 1rem;
	}

	.hidden {
	  display: none !important;
	}

	/* ========== Selectors & Controls ========== */
	#songSelector {
	  margin-bottom: 1rem;
	}

	#songDropdown {
	  padding: 0.4rem 0.8rem;
	  border-radius: 6px;
	  border: 1px solid #ccc;
	}

	#sequentialModeWrapper {
	  margin-top: 0.5rem;
	}

	/* ========== Bias Selector ========== */
	#biasSelector {
	  opacity: 0;
	  max-height: 0;
	  overflow: hidden;
	  transition: opacity 0.3s, max-height 0.3s;
	  margin-top: 1rem;
	}
	#biasSelector.show {
	  opacity: 1;
	  max-height: 500px;
	}

	#biasSelector label {
	  display: inline-block;
	  margin: 0.3rem;
	}

	/* ========== Audio Controls & Visualizer ========== */
	.custom-audio-controls {
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  margin: 1.5rem auto;
	  width: 100%;
	}

	.audio-button {
	  width: 64px;
	  height: 64px;
	  background-color: black;
	  color: white;
	  border-radius: 50%;
	  display: flex;
	  align-items: center;
	  margin: 0 auto;
	  justify-content: center;
	  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
	  border: none;
	  cursor: pointer;
	  transition: background-color 0.3s;
	}
	
	.audio-button:hover {
	  background-color: #333;
	}

	.icon {
	  width: 24px;
	  height: 24px;
	  fill: currentColor;
	}

	#visualizer {
	  width: 100%;
	  max-width: 100%;
	  height: 150px;
	  background-color: #000;
	  border-radius: 8px;
	  box-shadow: 0 0 10px white, inset 0 0 15px #666;
	}

	/* ========== Score & Stats Display ========== */
	.score-container {
	  font-size: 1.1rem;
	  margin-top: 2rem;
	}

	#scoreDisplay,
	#streakDisplay,
	#highScoreDisplay {
	  margin: 0.4rem 0;
	}
	
	#resetButton:hover {
	  background-color: var(--accent);
	  color: white;
	}

	/* ========== Guess Buttons (Theme-Aware) ========== */
	.buttons {
	  display: flex;
	  flex-wrap: wrap;
	  justify-content: center;
	  gap: 1rem;
	  margin-top: 2rem;
	}

	.guess-btn {
	  width: 120px;
	  height: 150px;
	  background: var(--card-bg);
	  color: var(--text-color);
	  border-radius: 12px;
	  border: 2px solid transparent;
	  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
	  font-weight: bold;
	  cursor: pointer;
	  transition: all 0.2s ease;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  backdrop-filter: blur(8px);
	  -webkit-backdrop-filter: blur(8px);
	}

	.guess-btn:hover {
	  transform: scale(1.05);
	  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	  border-color: var(--accent); /* From song theme */
	}

	.btn-content {
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	}

	.btn-content img {
	  width: 100px;
	  height: 100px;
	  border-radius: 10px;
	  object-fit: cover;
	  margin-bottom: 0.4rem;
	  box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
	}

	.btn-content span {
	  font-size: 0.9rem;
	  color: inherit; /* Inherits from body or theme-set override */
	  font-weight: bold;
	  text-align: center;
	}
	
	.guess-btn:hover img {
	  box-shadow: 0 0 10px var(--accent);
	}

	/* ========== Feedback ========== */
	#feedback {
	  position: fixed;
	  top: 50%;
	  left: 50%;
	  transform: translate(-50%, -50%);
	  font-size: 1.5rem;
	  font-weight: bold;
	  padding: 1.2rem 2rem;
	  border-radius: 12px;
	  box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
	  opacity: 0;
	  pointer-events: none;
	  z-index: 1000;
	  transition: opacity 0.3s ease;
	}

	#feedback.correct {
	  background-color: var(--correct-bg-light);
	  color: #155724;
	}
	#feedback.incorrect {
	  background-color: var(--incorrect-bg-light);
	  color: #721c24;
	}

	#feedback.show {
	  animation: feedbackIn 0.3s ease forwards;
	}
	#feedback:not(.show) {
	  animation: feedbackOut 0.3s ease forwards;
	}

	/* ========== Lyric Box ========== */
	.lyric-box {
	  background: var(--card-bg);
	  border: 1px solid rgba(255, 255, 255, 0.1);
	  border-radius: 12px;
	  padding: 1rem 1.5rem;
	  color: var(--text-color);
	  font-size: 1.2rem;
	  max-width: 90%;
	  margin: 1rem auto 0 auto;
	  text-align: center;
	  backdrop-filter: blur(6px);
	  -webkit-backdrop-filter: blur(6px);
	  transition: background 0.3s ease, color 0.3s ease;
	}

	.lyric-line {
	  opacity: 0;
	  transform: translateY(10px);
	  transition: opacity 0.4s ease, transform 0.4s ease;
	}
	.lyric-line.show {
	  opacity: 1;
	  transform: translateY(0);
	}

	/* ========== Animations ========== */
	@keyframes feedbackIn {
	  from { opacity: 0; transform: translate(-50%, -60%); }
	  to   { opacity: 1; transform: translate(-50%, -50%); }
	}

	@keyframes feedbackOut {
	  from { opacity: 1; transform: translate(-50%, -50%); }
	  to   { opacity: 0; transform: translate(-50%, -40%); }
	}

	@keyframes bounce {
	  0%, 100% { transform: scale(1); }
	  50% { transform: scale(1.15); }
	}

	@keyframes shake {
	  0% { transform: translateX(0); }
	  25% { transform: translateX(-6px); }
	  50% { transform: translateX(6px); }
	  75% { transform: translateX(-6px); }
	  100% { transform: translateX(0); }
	}

	/* Subtle pulsing glow for correct button border */
	@keyframes pulse-border {
	  0%, 100% { box-shadow: 0 0 8px 2px rgba(140, 82, 255, 0.6); }
	  50% { box-shadow: 0 0 12px 4px rgba(140, 82, 255, 0.9); }
	}

	/* Correct & Incorrect Button Feedback */

	.correct-flash-btn {
	  animation: bounce 0.3s ease-in-out;
	  box-shadow: 0 0 10px 4px rgba(140, 82, 255, 0.7); /* soft purple glow */
	  border-radius: 0.75rem;
	  transition: box-shadow 0.3s ease;
	}

	.correct-button {
	  animation: pulse-border 1.2s ease infinite;
	  border-color: rgba(140, 82, 255, 0.8);
	}

	.incorrect-shake {
	  animation: shake 0.4s ease-in-out;
	}

	/* ========== Mobile Responsiveness ========== */
	@media (max-width: 600px) {
	  .guess-btn {
		width: 100px;
		height: 130px;
	  }

	  .btn-content img {
		width: 80px;
		height: 80px;
	  }

	  .lyric-box {
		font-size: 1rem;
	  }

	  #visualizer {
		height: 120px;
	  }

	  .audio-button {
		width: 56px;
		height: 56px;
	  }
	}
	
	.glass-card {
	  background: var(--card-bg);
	  border: 1px solid rgba(255, 255, 255, 0.2);
	  border-radius: 16px;
	  padding: 2rem;
	  margin: 2rem auto;
	  max-width: 720px;
	  backdrop-filter: blur(10px);
	  -webkit-backdrop-filter: blur(10px);
	  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
	  transition: background 0.3s ease;
	}
	
	/* ========== Section & Form Group Layout ========== */
	.section-block {
	  margin-top: 1.5rem;
	  padding-top: 1rem;
	  border-top: 1px solid rgba(255, 255, 255, 0.1);
	}

	.form-group {
	  margin-bottom: 1rem;
	}

	.radio-group label {
	  margin-right: 1rem;
	}

	/* ========== Reset Button Group Styling ========== */
	.reset-button-group {
	  display: flex;
	  justify-content: center;
	  gap: 1rem;
	  margin-top: 1.25rem;
	}

	.reset-btn {
	  padding: 0.5rem 1.2rem;
	  font-size: 1rem;
	  border: 2px solid var(--accent);
	  border-radius: 8px;
	  background-color: var(--card-light);
	  color: var(--text-light);
	  cursor: pointer;
	  transition: all 0.3s ease;
	}

	.reset-btn:hover {
	  background-color: var(--accent);
	  color: white;
	}
	
	/* Unified stats box style */
	.stats-card {
	  margin-top: 2rem;
	  background: var(--card-bg);
	  color: var(--text-color);
	  padding: 1rem;
	  border-radius: 12px;
	  display: inline-block;
	  text-align: left;
	  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
	  transition: background 0.3s ease, color 0.3s ease;
	}
	
	.stats-wrapper {
	  display: flex;
	  flex-direction: column;
	  align-items: center; /* ensures both cards are horizontally centered */
	  gap: 1.5rem; /* nice breathing room between cards */
	}
</style>
</head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- in <head> -->
  <script defer data-domain="wavlyplace.github.io" src="https://plausible.io/js/script.tagged-events.js"></script>
  <script>
    window.plausible = window.plausible || function() {
      (window.plausible.q = window.plausible.q || []).push(arguments);
    }
  </script>
<body>
  <div class="glass-card">
	  <h1>🎤 tripleS Voice Quiz</h1>

	  <!-- SONG & MODE CONTROLS -->
	  <div class="section-block">
		<div id="songSelector" class="form-group">
		  <label for="songDropdown">Choose a song:</label>
		  <select id="songDropdown"></select>
		</div>

		<div id="sequentialModeWrapper" class="form-group" style="display: none;">
		  <label>
			<input type="checkbox" id="sequentialModeCheckbox">
			Sequential Mode
		  </label>
		</div>

		<div id="modeSelector" class="form-group radio-group">
		  <label><input type="radio" name="mode" value="all" checked> All Members</label>
		  <label><input type="radio" name="mode" value="bias"> My Biases</label>
		</div>

		<div class="form-group">
		  <label>
			<input type="checkbox" id="lyricModeCheckbox">
			Show Lyrics
		  </label>
		</div>
	  </div>

	  <!-- BIAS SELECTOR -->
	  <div id="biasSelector" class="section-block"></div>

	  <!-- AUDIO CONTROLS -->
	  <div class="section-block flex justify-center mt-4">
		<button id="playPauseBtn" class="audio-button">
		  <svg id="playIcon" class="icon" viewBox="0 0 24 24" fill="currentColor">
			<path d="M8 5v14l11-7z" />
		  </svg>
		  <svg id="pauseIcon" class="icon hidden" viewBox="0 0 24 24" fill="currentColor">
			<path d="M6 19h4V5H6zm8-14v14h4V5h-4z" />
		  </svg>
		</button>
	  </div>

	  <!-- SCORE & STATS -->
	  <div class="section-block score-container">
		<p id="scoreDisplay">🎯 Score: <span id="animatedScore">0</span> / <span id="attemptsCount">0</span> (<span id="accuracyPercent">0</span>%)</p>
		<p id="streakDisplay">🔥 Streak: 0</p>
		<p id="highScoreDisplay">🏆 High Score: 0</p>

		<div class="reset-button-group">
		  <button id="resetButton" class="reset-btn">Reset Score</button>
		  <button id="resetStatsBtn" class="reset-btn">Reset Stats</button>
		</div>
	  </div>
  </div>
  
  <audio id="audioPlayer"></audio>

  <canvas id="visualizer" width="800" height="150" style="width: 100%; height: 150px; margin-top: 1rem;"></canvas>
  
  <div id="lyricBox" class="lyric-box hidden">
	  <p id="lyricLine" class="lyric-line"></p>
  </div>

  <div class="buttons" id="guessButtons"></div>

  <div id="feedback" class="hidden"></div>

  <div class="stats-wrapper">
	  <div id="memberStats" class="stats-card">
		<h3>📊 Member Accuracy</h3>
		<ul id="memberStatsList"></ul>
	  </div>
	  
	  <div id="songStatsDisplay" class="stats-card">
		<h3>🎶 Song Progress</h3>
		<ul id="songStatsList"></ul>
	  </div>
  </div>
</body>

<script>
  let clips = [];
  let currentClip = null;
  let score = 0;
  let attempts = 0;
  let streak = 0;
  let highScore = parseInt(localStorage.getItem('highScore') || '0');
  let memberStats = {};
  const songStats = {};
  let isFirstLoad = true;
  let sourceNode;
  let animationId;

  let canvasAudioCtx = null;
  let canvasAnalyser = null;
  let canvasSource = null;
  let visualizerInitialized = false;
  let suppressNextLoadClipAlert = false; // Global or scoped above functions
  let previouslySelectedBiases = [];
  let sequentialIndex = 0;

  const memberColors = {
    Nakyoung: "#5F9EA0",
    Joobin: "#B7F54A",
    Hyerin: "#BF00FF",
    Seoah: "#CFF4FF",
    Kotone: "#FFDF00",
    Soomin: "#EF98AA",
    Xinyu: "#C80815",
    Hayeon: "#52D9BB",
    Lynn: "#AB62B4",
    Sohyun: "#1034A6",
	
	Shion: "#FF428A",
	Seoyeon: "#1E90FF",
	Chaeyeon: "#66CC33",
	Yubin: "#FFE4E1",
	Sullin: "#7BBA8D",
	Kaede: "#FFCC33",
	Dahyun: "#FBA0E3",
	Yooyeon: "#EC118F",
	Jiyeon: "#FEAA61",
	Mayu: "#FFA089",
	Yeonji: "#4169E1",
	Jiwoo: "#FAFA33",
	Chaewon: "#C7A3DF",
	Nien: "#FFA343"
  };
  
  function getMode() {
	  return document.querySelector('input[name="mode"]:checked').value;
	}
	
  function formatSongFolderName(songName) {
		return songName.toLowerCase().replace(/\s+/g, "");
	}
  
  function getMembersForSelectedSong() {
	  const selectedSong = document.getElementById('songDropdown').value;
	  const filteredClips = clips.filter(c => c.song === selectedSong);
	  const uniqueMembers = [...new Set(filteredClips.map(c => c.member))]; // no sort here
	  return uniqueMembers;
	}
	
  function isSequentialMode() {
	  const checkbox = document.getElementById('sequentialModeCheckbox');
	  return checkbox && checkbox.checked;
	}

  function renderGuessButtons() {
    const selectedMembers = getSelectedMembers();
	const customOrder = [
    "Seoyeon", "Hyerin", "Jiwoo", "Chaeyeon", "Yooyeon", "Soomin", "Nakyoung", "Yubin", "Kaede", "Dahyun", "Kotone", "Yeonji",
    "Nien", "Sohyun", "Xinyu", "Mayu", "Lynn", "Joobin", "Hayeon", "Shion", "Chaewon", "Sullin", "Seoah", "Jiyeon"
  ];
  selectedMembers.sort((a, b) => customOrder.indexOf(a) - customOrder.indexOf(b));

    const buttonContainer = document.getElementById('guessButtons');
    buttonContainer.innerHTML = '';

    selectedMembers.forEach(member => {
      memberStats[member] = memberStats[member] || { appearances: 0, correctGuesses: 0 };

      const btn = document.createElement('button');
      btn.className = 'guess-btn';
      btn.onclick = () => guess(btn);
      btn.style.borderColor = memberColors[member];
      btn.dataset.name = member;

      const content = document.createElement('div');
      content.className = 'btn-content';

      const img = document.createElement('img');
      const selectedSong = document.getElementById('songDropdown').value;
	  const songFolder = formatSongFolderName(selectedSong);
	  const fileSafeMember = member.toLowerCase().replace(/\s+/g, '');
	  img.src = `img/members/${songFolder}/${fileSafeMember}.jpg`;

      img.alt = member;

      const label = document.createElement('span');
      label.textContent = member;

      content.appendChild(img);
      content.appendChild(label);
      btn.appendChild(content);
      buttonContainer.appendChild(btn);
    });
  }
  
  function formatSongFolderName(songName) {
	  if (songName === 'All Songs') return 'default';
	  return songName.toLowerCase().replace(/[^a-z0-9]/g, '');
	}

  function populateBiasSelector() {
	  const container = document.getElementById('biasSelector');
	  container.innerHTML = '';

	  const selectedSong = document.getElementById('songDropdown').value;
	  let relevantClips = clips;

	  if (selectedSong !== 'All Songs') {
		relevantClips = clips.filter(c => c.song === selectedSong);
	  }

	  const songMembers = [...new Set(relevantClips.map(c => c.member))];

	  const customOrder = [
		"Seoyeon", "Hyerin", "Jiwoo", "Chaeyeon", "Yooyeon", "Soomin", "Nakyoung", "Yubin",
		"Kaede", "Dahyun", "Kotone", "Yeonji", "Nien", "Sohyun", "Xinyu", "Mayu", "Lynn",
		"Joobin", "Hayeon", "Shion", "Chaewon", "Sullin", "Seoah", "Jiyeon"
	  ];

	  const orderedMembers = songMembers.slice().sort(
		(a, b) => customOrder.indexOf(a) - customOrder.indexOf(b)
	  );

	  orderedMembers.forEach(member => {
		const label = document.createElement('label');
		label.style.marginRight = '1rem';

		const checkbox = document.createElement('input');
		checkbox.type = 'checkbox';
		checkbox.value = member;
		checkbox.checked = previouslySelectedBiases.includes(member);

		checkbox.addEventListener('change', () => {
		  const selectedBiases = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
		  previouslySelectedBiases = selectedBiases; // ✅ Remember selections
		  renderGuessButtons();
		  loadNextClip();
		});

		label.appendChild(checkbox);
		label.appendChild(document.createTextNode(` ${member}`));
		container.appendChild(label);
	  });
	}

  function populateSongSelector(songs) {
	  const dropdown = document.getElementById('songDropdown');
	  dropdown.innerHTML =`<option value="All Songs">All Songs</option>` + songs.map(song => `<option value="${song}">${song}</option>`).join('');
	}
	
  function ensureSongStats(song) {
		if (!songStats[song]) {
			songStats[song] = {
				appearances: 0,
				correctGuesses: 0
			};
		}
	}

  function updateModeUI() {
		const mode = getMode();
		const biasSelector = document.getElementById('biasSelector');

		if (mode === 'bias') {
			biasSelector.classList.add('show');
			populateBiasSelector();

			setTimeout(() => {
				suppressNextLoadClipAlert = true; // ✅ Move inside setTimeout
				document.querySelectorAll('#biasSelector input[type="checkbox"]').forEach(cb => cb.checked = false);
				renderGuessButtons();
				loadNextClip();
			}, 0);
		} else {
			biasSelector.classList.remove('show');

			// ✅ Ensure all checkboxes are checked when exiting Bias mode
			document.querySelectorAll('#biasSelector input[type="checkbox"]').forEach(cb => cb.checked = true);
			renderGuessButtons();
			loadNextClip();
		}
	}

  function getSelectedMembers() {
	  const selectedSong = document.getElementById('songDropdown').value;
	  const mode = document.querySelector('input[name="mode"]:checked').value;

	  let relevantClips = clips;

	  if (selectedSong !== 'All Songs') {
		relevantClips = clips.filter(c => c.song === selectedSong);
	  }

	  const songMembers = [...new Set(relevantClips.map(c => c.member))];

	  if (mode === 'bias') {
		const selectedBiases = Array.from(document.querySelectorAll('#biasSelector input[type="checkbox"]:checked')).map(cb => cb.value);
		return selectedBiases.filter(bias => songMembers.includes(bias));
	  }

	  return songMembers;
	}

  async function loadClips() {
	  try {
		// Fetch the raw clips JSON file
		const response = await fetch('clips.json'); // Replace with your JSON path
		if (!response.ok) {
		  throw new Error(`HTTP error! status: ${response.status}`);
		}
		const rawClips = await response.json();

		// Map to internal format
		clips = rawClips.map(c => ({
		  id: c.ID,
		  member: c.Member,
		  song: c.Song,
		  filename: c.Filename,
		  timestamp: c.Timestamp,
		  difficulty: c.Difficulty,
		  notes: c.Notes,
		  lyric: c.Lyric
		}));

		console.log("Raw clips loaded:", rawClips.length);
		console.log("Mapped clips:", clips.length);

		// Now, once clips are loaded, do all this:
		console.log("Mapped clips:", clips);

		const allMembers = [...new Set(clips.map(c => c.member))];
		const allSongs = [...new Set(clips.map(c => c.song?.trim()).filter(Boolean))];

		console.log("All songs:", allSongs);

		populateBiasSelector(allMembers);
		populateSongSelector(allSongs);
		console.log('Detected songs:', allSongs);

		document.querySelectorAll('input[name="mode"]').forEach(radio => {
		  radio.addEventListener('change', () => {
			updateModeUI();
			if (radio.value === 'bias') {
			  populateBiasSelector(allMembers);
			}
		  });
		});

		renderGuessButtons();
		loadNextClip();

		document.getElementById('songDropdown').addEventListener('change', () => {
		  const selectedSong = document.getElementById('songDropdown').value;
		  const sequentialWrapper = document.getElementById('sequentialModeWrapper');
		  const sequentialCheckbox = document.getElementById('sequentialModeCheckbox');

		  // 🔎 Track song change with Plausible
		  plausible('Song Change', {
			props: { song: selectedSong }
		  });

		  if (selectedSong === 'All Songs') {
			sequentialWrapper.style.display = 'none';
			sequentialCheckbox.checked = false;
		  } else {
			sequentialWrapper.style.display = 'block';
		  }

		  if (sequentialCheckbox.checked && selectedSong !== 'All Songs') {
			sequentialIndex = 0;
		  }

		  const mode = document.querySelector('input[name="mode"]:checked').value;
		  if (mode === 'bias') populateBiasSelector(allMembers);

		  renderGuessButtons();
		  loadNextClip();
		});
		
		document.getElementById('sequentialModeCheckbox').addEventListener('change', () => {
		  const isSequential = document.getElementById('sequentialModeCheckbox').checked;

		  if (isSequential) {
			sequentialIndex = 0;
			loadNextClip(); // 🔁 Start sequence fresh
		  } else {
			loadNextClip(); // 🎲 Go back to random mode
		  }
		});

		document.querySelectorAll('input[name="mode"]').forEach(radio => {
		  radio.addEventListener('change', updateModeUI);
		});

	  } catch (error) {
		console.error("Failed to load clips:", error);
	  }
	}
	
  document.getElementById('lyricModeCheckbox').addEventListener('change', updateLyricBox);

  function loadNextClip() {
		const selectedMembers = getSelectedMembers();
		const selectedSong = document.getElementById('songDropdown').value;
		const isAllSongs = selectedSong === 'All Songs';
		const songKey = isAllSongs ? 'All Songs' : selectedSong;

		const inkigayoTheme = {
			background: '#000000',
			gradientFrom: 'rgba(255, 255, 255, 1)',
			gradientTo: 'rgba(255, 255, 255, 0.1)',
			shadowColor: 'white'
		};

		const filteredClips = clips.filter(clip => {
			const matchesSong = isAllSongs || clip.song === selectedSong;
			const matchesMember = selectedMembers.includes(clip.member);
			return matchesSong && matchesMember;
		});

		if (filteredClips.length === 0) {
			if (!isFirstLoad && !suppressNextLoadClipAlert) {
				alert('No clips match this selection!');
			}
			suppressNextLoadClipAlert = false;
			return;
		}

		suppressNextLoadClipAlert = false;
		isFirstLoad = false;

		// 🎯 Sequential Mode
		if (isSequentialMode() && !isAllSongs) {
			filteredClips.sort((a, b) => a.ID - b.ID);
			if (sequentialIndex >= filteredClips.length) {
				alert("You've reached the end of the clips for this song! Starting over.");
				sequentialIndex = 0;
			}
			currentClip = filteredClips[sequentialIndex];
			sequentialIndex++;
		} else {
			currentClip = filteredClips[Math.floor(Math.random() * filteredClips.length)];
		}
		
		ensureSongStats(currentClip.song);

		// 🔈 Set Audio
		const folder = formatSongFolderName(currentClip.song);
		const audioPlayer = document.getElementById('audioPlayer');
		audioPlayer.src = `audio/${folder}/${currentClip.filename}`;

		audioPlayer.addEventListener('play', () => updatePlayPauseIcon(true));
		audioPlayer.addEventListener('pause', () => updatePlayPauseIcon(false));
		audioPlayer.addEventListener('ended', () => updatePlayPauseIcon(false));

		// 🌈 THEME SETUP
		const theme = visualizerThemes[songKey] || inkigayoTheme;
		const pageTheme = songThemes[songKey];

		setupCanvasVisualizer(audioPlayer, theme);
		audioPlayer.load();
		audioPlayer.play().catch(e => console.log('Autoplay failed:', e));

		updateLyricBox();
		loadSongStats();
		loadMemberStats();

		const root = document.documentElement;

		if (pageTheme) {
			document.body.style.background = `${pageTheme.backgroundGradient}, ${pageTheme.background}`;
			document.body.style.color = pageTheme.textColor;

			root.style.setProperty('--accent', pageTheme.accent || '#8c52ff');
			root.style.setProperty('--text-color', pageTheme.textColor || '#222');
			root.style.setProperty('--card-bg', pageTheme.cardBg || 'rgba(255, 255, 255, 0.4)');
		} else {
			// Fallback theme
			document.body.style.background = 'var(--bg-light)';
			document.body.style.color = 'var(--text-light)';
			root.style.setProperty('--accent', '#8c52ff');
			root.style.setProperty('--text-color', 'var(--text-light)');
			root.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.4)');
		}
	}
	
  function updateLyricBox() {
	  const lyricBox = document.getElementById('lyricBox');
	  const lyricLine = document.getElementById('lyricLine');
	  const lyricModeCheckbox = document.getElementById('lyricModeCheckbox');
	  const isLyricMode = lyricModeCheckbox.checked;

	  if (isLyricMode && currentClip && currentClip.lyric) {
		lyricBox.classList.remove('hidden');

		const lines = currentClip.lyric.split(' / ');
		lyricLine.classList.remove('show');
		setTimeout(() => {
		  lyricLine.innerHTML = lines.join('<br>');
		  lyricLine.classList.add('show');
		}, 100);
	  } else {
		lyricBox.classList.add('hidden');
	  }
	}

	const audio = document.getElementById('audioPlayer');
	audio.addEventListener('play', () => updatePlayPauseIcon(true));
	audio.addEventListener('pause', () => updatePlayPauseIcon(false));
	const playBtn = document.getElementById('playPauseBtn');
	const playIcon = document.getElementById('playIcon');
	const pauseIcon = document.getElementById('pauseIcon');
	const svg = document.getElementById('visualizer');
	const NUM_BARS = 64;

  const visualizerThemes = {
	  "Are You Alive": {
		background: "#0b1d2a",  // dark navy with green undertones
		gradientFrom: "rgba(0, 204, 204, 1)",  // teal highlight
		gradientTo: "rgba(0, 204, 204, 0.1)",
		shadowColor: "#00cccc"
	  },
	  "Hit the Floor": {
		background: "#2a0000",  // rich black-red
		gradientFrom: "rgba(255, 70, 70, 1)",  // punchy red
		gradientTo: "rgba(255, 70, 70, 0.1)",
		shadowColor: "#ff4444"
	  },
	  "Untitled": {
		background: "#1a1410",  // muted earthy brown
		gradientFrom: "rgba(177, 114, 62, 1)",  // blue tone
		gradientTo: "rgba(132, 101, 76, 0.1)",
		shadowColor: "#c78638",
	  },
	  "Inner Dance": {
		background: "#6b003b",  // plum pink
		gradientFrom: "rgba(255, 192, 203, 1)",  // soft pink
		gradientTo: "rgba(255, 192, 203, 0.1)",
		shadowColor: "#ffc0cb"
	  },
	  "Girls Never Die": {
		background: "#0f0f0f",  // blackest black
		gradientFrom: "rgba(255, 255, 255, 0.6)",  // silver glow
		gradientTo: "rgba(255, 255, 255, 0.1)",
		shadowColor: "#ffffff"
	  },
	  "Door": {
		background: "#fff4f6",  // very soft pink
		gradientFrom: "rgba(255, 182, 193, 1)",  // cherry blossom
		gradientTo: "rgba(255, 182, 193, 0.1)",
		shadowColor: "#ffb6c1"
	  },
	  "Just Do It": {
		background: "#001a33",  // deep navy
		gradientFrom: "rgba(80, 160, 220, 1)",  // icy blue
		gradientTo: "rgba(80, 160, 220, 0.1)",
		shadowColor: "#50a0dc"
	  },
	  "Invincible": {
		background: "#0d1117",  // dark slate
		gradientFrom: "rgba(100, 200, 255, 1)",  // electric sky blue
		gradientTo: "rgba(100, 200, 255, 0.1)",
		shadowColor: "#64c8ff"
	  },
	  "Girls Capitalism": {
		background: "#e9f2fa",  // gentle baby blue
		gradientFrom: "rgba(150, 200, 255, 1)",  // pastel sky
		gradientTo: "rgba(150, 200, 255, 0.1)",
		shadowColor: "#a8c8f0"
	  }
	};
	
	const songThemes = {
	  "Are You Alive": {
		accent: "#3FA9F5",
		textColor: "#E3F2FD",
		background: "#0B1C2C",
		backgroundGradient: "linear-gradient(135deg, #0E3D59, #155E75)",
		cardBg: "rgba(16, 32, 48, 0.5)",
	  },
	  "Hit the Floor": {
		accent: "#FF4B4B",
		textColor: "#FFECEC",
		background: "#1A0000",
		backgroundGradient: "linear-gradient(135deg, #6E0B0B, #1A0000)",
		cardBg: "rgba(40, 0, 0, 0.5)",
	  },
	  "Untitled": {
		accent: "#B57A5A",
		textColor: "#FAF3EB",
		background: "#1F1612",
		backgroundGradient: "linear-gradient(135deg, #5A3A2E, #2E1D14)",
		cardBg: "rgba(60, 45, 35, 0.45)",
	  },
	  "Inner Dance": {
		accent: "#F6A5C0",
		textColor: "#FFF0F5",
		background: "#91426C",
		backgroundGradient: "linear-gradient(135deg, #F9A8D4, #91426C)",
		cardBg: "rgba(255, 192, 203, 0.15)",
	  },
	  "Girls Never Die": {
		accent: "#FFFFFF",
		textColor: "#FFFFFF",
		background: "#000000",
		backgroundGradient: "linear-gradient(135deg, #333333, #000000)",
		cardBg: "rgba(255, 255, 255, 0.05)",
	  },
	  "Door": {
		accent: "#FFB6C1",
		textColor: "#4A2A2A",
		background: "#FFF0F5",
		backgroundGradient: "linear-gradient(135deg, #FFD1DC, #FFF0F5)",
		cardBg: "rgba(255, 182, 193, 0.2)",
	  },
	  "Just Do It": {
		accent: "#1E88E5",
		textColor: "#DDEEFF",
		background: "#0D1F3F",
		backgroundGradient: "linear-gradient(135deg, #1E88E5, #0D1F3F)",
		cardBg: "rgba(13, 31, 63, 0.45)",
	  },
	  "Invincible": {
		accent: "#A1D7EF",
		textColor: "#E1F5FE",
		background: "#0C1114",
		backgroundGradient: "linear-gradient(135deg, #0C1114, #3A9ED9)",
		cardBg: "rgba(10, 30, 45, 0.4)",
	  },
	  "Girls Capitalism": {
		accent: "#6C92B5",
		textColor: "#1B1B1B",
		background: "#D1DAE7",
		backgroundGradient: "linear-gradient(135deg, #B2C9E3, #D1DAE7)",
		cardBg: "rgba(220, 230, 240, 0.3)",
	  },

	  // 🎤 "All Songs" Theme (Inkigayo style)
	  "All Songs": {
		accent: "#FFFFFF",
		textColor: "#FFFFFF",
		background: "#000000",
		backgroundGradient: "linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05))",
		cardBg: "rgba(255, 255, 255, 0.05)",
	  }
	};

  function setVisualizerStyle(styleName) {
	  if (visualizerStyles[styleName]) {
		currentStyle = visualizerStyles[styleName];
	  }
	}

  let visualizerTheme = null;  // global or higher scope variable

  function setupCanvasVisualizer(audioElement, theme) {
	  if (!visualizerInitialized) {
		// One-time setup
		const canvas = document.getElementById('visualizer');
		const canvasCtx = canvas.getContext('2d');

		canvasAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
		canvasAnalyser = canvasAudioCtx.createAnalyser();
		canvasSource = canvasAudioCtx.createMediaElementSource(audioElement);

		canvasSource.connect(canvasAnalyser);
		canvasAnalyser.connect(canvasAudioCtx.destination);

		canvasAnalyser.fftSize = 256;
		bufferLength = canvasAnalyser.frequencyBinCount;
		dataArray = new Uint8Array(bufferLength);

		barWidth = 10;
		barGap = 4;

		visualizerTheme = theme; // initialize with first theme

		function draw() {
		  requestAnimationFrame(draw);

		  const width = canvas.width = canvas.offsetWidth;
		  const height = canvas.height = canvas.offsetHeight;

		  canvasCtx.clearRect(0, 0, width, height);
		  canvasCtx.fillStyle = visualizerTheme.background;
		  canvasCtx.fillRect(0, 0, width, height);

		  canvasAnalyser.getByteFrequencyData(dataArray);

		  for (let i = 0; i < bufferLength; i++) {
			const volume = dataArray[i] / 255;
			const scaledHeight = volume * height * 0.9;

			const x = i * (barWidth + barGap);
			const y = height - scaledHeight;

			const gradient = canvasCtx.createLinearGradient(x, y, x, height);
			gradient.addColorStop(0, visualizerTheme.gradientFrom);
			gradient.addColorStop(1, visualizerTheme.gradientTo);

			canvasCtx.shadowColor = visualizerTheme.shadowColor;
			canvasCtx.shadowBlur = visualizerTheme.shadowBlur || 10;

			canvasCtx.fillStyle = gradient;
			canvasCtx.fillRect(x, y, barWidth, scaledHeight);
		  }

		  canvasCtx.shadowBlur = 0;
		}

		draw();
		visualizerInitialized = true;

	  } else {
		// Visualizer already initialized, just update the theme variable
		visualizerTheme = theme;
	  }
	}

  function guess(button) {
		const selectedMember = button.dataset.name;
		const isCorrect = selectedMember === currentClip.member;
		attempts++;
		memberStats[currentClip.member].appearances++;
		songStats[currentClip.song].appearances++; // ✅ Always increase appearances

		plausible('Guess', {
			props: {
				guessed: selectedMember,
				correct: currentClip.member,
				result: isCorrect ? 'correct' : 'incorrect',
				song: currentClip.song
			}
		});

		if (isCorrect) {
			score++;
			streak++;
			memberStats[selectedMember].correctGuesses++;
			songStats[currentClip.song].correctGuesses++; // ✅ Track correct guess per song

			button.classList.add('correct-button');
			const img = button.querySelector('img');
			if (img) img.classList.add('correct-flash-btn');

			setTimeout(() => {
				button.classList.remove('correct-button');
				if (img) img.classList.remove('correct-flash-btn');
			}, 1000);

			if (score > highScore) {
				highScore = score;
				localStorage.setItem('highScore', highScore);
			}
		} else {
			streak = 0;
			button.classList.add('incorrect-shake');
			setTimeout(() => {
				button.classList.remove('incorrect-shake');
			}, 400);
		}
		
		saveSongStats();
		saveMemberStats();

		showFeedback(
			isCorrect ? '✅ Correct!' : `❌ Nope! It was ${currentClip.member}.`,
			isCorrect
		);
	}

	function updateStats() {
	  const accuracy = attempts === 0 ? 0 : ((score / attempts) * 100).toFixed(1);

	  // Only animate score — don't touch it elsewhere
	  const scoreElement = document.getElementById('animatedScore');
	  if (scoreElement) {
		animateCountUp(scoreElement, score, 0);
	  }

	  document.getElementById('attemptsCount').textContent = attempts;
	  document.getElementById('accuracyPercent').textContent = accuracy;
	  document.getElementById('streakDisplay').textContent = `🔥 Streak: ${streak}`;
	  document.getElementById('highScoreDisplay').textContent = `🏆 High Score: ${highScore}`;
	}

  function renderMemberStats() {
	  const list = document.getElementById('memberStatsList');
	  if (!list) return;

	  list.innerHTML = ''; // Clear previous content

	  for (const [member, stats] of Object.entries(memberStats)) {
		const accuracy = stats.appearances === 0 ? '—' :
		  ((stats.correctGuesses / stats.appearances) * 100).toFixed(1) + '%';
		const li = document.createElement('li');
		li.textContent = `${member}: ${stats.correctGuesses} / ${stats.appearances} (${accuracy})`;
		list.appendChild(li);
	  }
	}
  
  function renderSongStats() {
	  const list = document.getElementById('songStatsList');
	  list.innerHTML = '';

	  Object.keys(songStats).forEach(song => {
		const { appearances, correctGuesses } = songStats[song];
		const accuracy = appearances ? ((correctGuesses / appearances) * 100).toFixed(1) : "0.0";

		const li = document.createElement('li');
		li.textContent = `${song}: ${correctGuesses}/${appearances} (${accuracy}%)`;
		list.appendChild(li);
	  });
  }

  function resetScore() {
    score = 0;
    attempts = 0;
    streak = 0;
    for (const member in memberStats) {
      memberStats[member] = { appearances: 0, correctGuesses: 0 };
    }
    updateStats();
    renderMemberStats();
  }

  function showFeedback(message, isCorrect) {
    const feedback = document.getElementById('feedback');
    feedback.textContent = message;
    feedback.className = `show ${isCorrect ? 'correct' : 'incorrect'}`;
    setTimeout(() => {
      feedback.classList.remove('show', 'correct', 'incorrect');
      updateStats();
      renderMemberStats();
	  renderSongStats();
      loadNextClip();
    }, 1500);
  }
  
	function animateCountUp(element, newValue, duration = 1000) {
	  const start = parseInt(element.textContent) || 0;

	  if (start === newValue) return;

	  const startTime = performance.now();

	  function update(currentTime) {
		const elapsed = currentTime - startTime;
		const progress = Math.min(elapsed / duration, 1);
		const currentValue = Math.floor(start + (newValue - start) * progress);

		element.textContent = currentValue;

		if (progress < 1) {
		  requestAnimationFrame(update);
		}
	  }

	  requestAnimationFrame(update);
	}
	
	function markButtonCorrect(button) {
	  button.classList.add('correct-button');
	  button.querySelector('img')?.classList.add('correct-flash');
	  // Remove classes after animation ends
	  setTimeout(() => {
		button.classList.remove('correct-button');
		button.querySelector('img')?.classList.remove('correct-flash');
	  }, 1200); // Matches pulse-border duration
	}

	function markButtonIncorrect(button) {
	  button.classList.add('incorrect-shake');
	  setTimeout(() => {
		button.classList.remove('incorrect-shake');
	  }, 400); // Matches shake duration
	}
	
	playBtn.addEventListener('click', async () => {
	  if (canvasAudioCtx && canvasAudioCtx.state === 'suspended') {
		await canvasAudioCtx.resume();
	  }

	  if (audio.paused) {
		await audio.play();
	  } else {
		audio.pause();
	  }

	  // 👇 Use your helper instead of manually toggling icons
	  updatePlayPauseIcon(!audio.paused);
	});
	
	function updatePlayPauseIcon(isPlaying) {
	  const playIcon = document.getElementById('playIcon');
	  const pauseIcon = document.getElementById('pauseIcon');

	  if (isPlaying) {
		playIcon.classList.add('hidden');
		pauseIcon.classList.remove('hidden');
	  } else {
		playIcon.classList.remove('hidden');
		pauseIcon.classList.add('hidden');
	  }
	}
	
	function saveSongStats() {
		localStorage.setItem('songStats', JSON.stringify(songStats));
	}
	
	function saveMemberStats() {
		localStorage.setItem('memberStats', JSON.stringify(memberStats));
	}
	
	function loadSongStats() {
		const storedStats = localStorage.getItem('songStats');
		if (storedStats) {
			Object.assign(songStats, JSON.parse(storedStats));
		}
	}
	
	function loadMemberStats() {
		const stored = localStorage.getItem('memberStats');
		if (stored) {
			Object.assign(memberStats, JSON.parse(stored));
		}
	}
	
	function resetSongStats() {
		localStorage.removeItem('songStats');
		for (let song in songStats) {
			songStats[song].appearances = 0;
			songStats[song].correctGuesses = 0;
		}
		renderMemberStats(); // Or your equivalent re-rendering function
	}
	
	function resetAllStats() {
		localStorage.removeItem('songStats');
		localStorage.removeItem('memberStats');

		for (const song in songStats) {
			songStats[song].appearances = 0;
			songStats[song].correctGuesses = 0;
		}
		for (const member in memberStats) {
			memberStats[member].appearances = 0;
			memberStats[member].correctGuesses = 0;
		}

		updateStats();         // For score/streak display
		renderMemberStats();   // For per-member breakdown
		alert("All stats have been reset.");
	}
	
	document.getElementById('resetStatsBtn').addEventListener('click', resetAllStats);

  window.onload = () => {
    loadClips();
    document.getElementById('resetButton').addEventListener('click', resetScore);
    updateStats();
  };
</script>
</body>
</html>
